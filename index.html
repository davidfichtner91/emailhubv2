<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Email Hub v11 â€” Klaviyo Campaign Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #07080d;
  --s1: #0e0f18;
  --s2: #141520;
  --s3: #1c1d2e;
  --border: #252638;
  --accent: #3d6eff;
  --accent-glow: rgba(61,110,255,0.25);
  --green: #00e5a0;
  --green-dim: rgba(0,229,160,0.12);
  --red: #ff4560;
  --red-dim: rgba(255,69,96,0.12);
  --amber: #ffb020;
  --amber-dim: rgba(255,176,32,0.12);
  --vip: #c084fc;
  --vip-dim: rgba(192,132,252,0.12);
  --text: #e8eaf6;
  --muted: #5a5c7a;
  --muted2: #3a3c58;
  --us: #4fa3ff; --uk: #7b6fff; --cz: #ff5a7e; --de: #ffcc4d; --eu: #4fffce; --sg: #ff8c4f;
}

body { background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; min-height: 100vh; font-size: 13px; }
body::after { content: ''; position: fixed; inset: 0; opacity: 0.025; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E"); pointer-events: none; z-index: 9999; }

/* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar {
  background: var(--s1); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 16px; gap: 10px;
  position: sticky; top: 0; z-index: 50; height: 52px; flex-wrap: wrap;
}
.logo { font-family: 'Bricolage Grotesque', sans-serif; font-weight: 800; font-size: 16px; display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.logo-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px var(--accent); }
.logo span { color: var(--accent); }
.tsep { width: 1px; height: 18px; background: var(--border); flex-shrink: 0; }
.camp-wrap { display: flex; align-items: center; gap: 7px; flex: 1; min-width: 0; max-width: 360px; }
.camp-label { font-size: 9px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; white-space: nowrap; }
.camp-input { background: var(--s2); border: 1px solid var(--border); border-radius: 7px; color: var(--text); font-family: 'Bricolage Grotesque', sans-serif; font-weight: 600; font-size: 13px; padding: 6px 10px; flex: 1; outline: none; transition: border-color 0.2s; min-width: 0; }
.camp-input:focus { border-color: var(--accent); }
.camp-input::placeholder { color: var(--muted); font-weight: 400; }
.topbar-right { margin-left: auto; display: flex; gap: 7px; align-items: center; flex-shrink: 0; }
.badge { font-size: 10px; padding: 3px 9px; border-radius: 100px; background: var(--s3); border: 1px solid var(--border); color: var(--muted); }
.vip-badge { background: var(--vip-dim); border-color: rgba(192,132,252,0.3); color: var(--vip); display: none; }
.vip-badge.show { display: inline-flex; align-items: center; gap: 4px; }

/* â”€â”€ MAIN NAV TABS (top, always visible) â”€â”€â”€â”€â”€â”€â”€ */
.mainnav {
  background: var(--s1); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 16px; gap: 2px;
  overflow-x: auto; flex-shrink: 0;
}
.mainnav::-webkit-scrollbar { display: none; }
.mnav-tab {
  display: flex; align-items: center; gap: 6px;
  padding: 10px 16px; font-size: 12px; cursor: pointer;
  border: none; background: transparent; color: var(--muted);
  font-family: 'JetBrains Mono', monospace; transition: all 0.15s;
  border-bottom: 2px solid transparent; white-space: nowrap;
  margin-bottom: -1px;
}
.mnav-tab:hover { color: var(--text); }
.mnav-tab.active { color: var(--text); border-bottom-color: var(--accent); }
.mnav-tab .ni { font-size: 13px; }
.store-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-body { height: calc(100vh - 101px); overflow-y: auto; }
.panel { display: none; padding: 24px 20px 80px; max-width: 860px; margin: 0 auto; }
.panel.active { display: block; }

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card { background: var(--s1); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 14px; }
.card-head { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 9px; }
.card-title { font-family: 'Bricolage Grotesque', sans-serif; font-weight: 600; font-size: 13px; }
.card-hint { font-size: 10px; color: var(--muted); margin-left: auto; }
.card-body { padding: 16px; }
.sbar { width: 3px; min-height: 16px; border-radius: 4px; background: var(--sc, var(--accent)); flex-shrink: 0; }

/* â”€â”€ API KEY HIGHLIGHT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.api-key-row {
  background: rgba(61,110,255,0.06); border: 1px solid rgba(61,110,255,0.2);
  border-radius: 10px; padding: 14px 16px; margin-bottom: 14px;
}
.api-key-label-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.api-key-label-row .field-label { color: var(--accent); font-size: 10px; }
.api-key-status { font-size: 10px; margin-left: auto; padding: 2px 8px; border-radius: 4px; }
.api-key-status.set { background: var(--green-dim); color: var(--green); }
.api-key-status.missing { background: var(--red-dim); color: var(--red); }

/* â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field { display: flex; flex-direction: column; gap: 4px; }
.field-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); }
input[type="text"], input[type="email"], input[type="password"], input[type="color"], textarea, select {
  background: var(--s2); border: 1px solid var(--border); border-radius: 7px;
  color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 12px;
  padding: 8px 11px; width: 100%; outline: none; transition: border-color 0.2s, background 0.2s;
}
input:focus, textarea:focus, select:focus { border-color: var(--accent); background: var(--s3); }
input::placeholder, textarea::placeholder { color: var(--muted2); }
select option { background: var(--s2); }
textarea { resize: vertical; line-height: 1.7; min-height: 80px; }
input[type="color"] { padding: 3px 5px; height: 34px; cursor: pointer; }
.g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.g3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
.g4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; }
.s2 { grid-column: span 2; } .s3 { grid-column: span 3; } .sa { grid-column: 1/-1; }

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 7px; font-family: 'Bricolage Grotesque', sans-serif; font-weight: 600; font-size: 12px; cursor: pointer; border: none; transition: all 0.15s; white-space: nowrap; }
.btn-primary { background: var(--accent); color: white; box-shadow: 0 0 16px var(--accent-glow); }
.btn-primary:hover { background: #5580ff; transform: translateY(-1px); }
.btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); }
.btn-ghost:hover { color: var(--text); background: var(--s2); }
.btn-green { background: var(--green-dim); color: var(--green); border: 1px solid rgba(0,229,160,0.25); }
.btn-green:hover { background: rgba(0,229,160,0.2); }
.btn-vip { background: var(--vip-dim); color: var(--vip); border: 1px solid rgba(192,132,252,0.25); }
.btn-sm { padding: 5px 10px; font-size: 11px; border-radius: 6px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

/* â”€â”€ REGION TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rtabs { display: flex; gap: 3px; margin-bottom: 16px; background: var(--s1); padding: 3px; border-radius: 9px; border: 1px solid var(--border); width: fit-content; flex-wrap: wrap; }
.rtab { padding: 6px 14px; border-radius: 6px; font-size: 11px; cursor: pointer; border: 1px solid transparent; background: transparent; color: var(--muted); font-family: 'JetBrains Mono', monospace; transition: all 0.15s; display: flex; align-items: center; gap: 5px; }
.rtab:hover { color: var(--text); background: var(--s2); }
.rtab.active { background: var(--s2); border-color: var(--border); color: var(--text); }
.rdot { width: 5px; height: 5px; border-radius: 50%; background: var(--rc, #fff); flex-shrink: 0; }
.rtab.active .rdot { box-shadow: 0 0 6px var(--rc, #fff); }
.rpanel { display: none; } .rpanel.active { display: block; }

/* â”€â”€ TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-row { display: flex; align-items: center; gap: 9px; }
.tog { width: 34px; height: 19px; border-radius: 10px; background: var(--s3); border: 1px solid var(--border); position: relative; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
.tog.on { background: var(--accent); border-color: var(--accent); }
.tog.vip-on { background: var(--vip); border-color: var(--vip); }
.tog::after { content: ''; position: absolute; width: 13px; height: 13px; border-radius: 50%; background: white; top: 2px; left: 2px; transition: left 0.2s; }
.tog.on::after, .tog.vip-on::after { left: 17px; }
.tog-label { font-size: 12px; }
.tog-sub { font-size: 10px; color: var(--muted); margin-left: auto; }

/* â”€â”€ VIP SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.vip-section { display: none; margin-top: 14px; }
.vip-section.show { display: block; }
.vip-card { background: rgba(192,132,252,0.05); border: 1px solid rgba(192,132,252,0.2); border-radius: 10px; padding: 14px; }
.vip-title { font-family: 'Bricolage Grotesque', sans-serif; font-weight: 700; font-size: 12px; color: var(--vip); display: flex; align-items: center; gap: 6px; margin-bottom: 12px; }

/* â”€â”€ RTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rte-wrap { border: 1px solid var(--border); border-radius: 7px; overflow: hidden; transition: border-color 0.2s; background: var(--s2); }
.rte-wrap:focus-within { border-color: var(--accent); background: var(--s3); }
.rte-tb { display: flex; align-items: center; gap: 2px; padding: 4px 6px; background: var(--s1); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
.rte-btn { width: 24px; height: 24px; border-radius: 4px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; font-family: 'Bricolage Grotesque', sans-serif; font-weight: 700; }
.rte-btn:hover { background: var(--s2); color: var(--text); }
.rte-sep { width: 1px; height: 14px; background: var(--border); margin: 0 3px; }
.rte-link-btn { display: flex; align-items: center; gap: 4px; padding: 0 8px; height: 24px; border-radius: 4px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-size: 10px; font-family: 'JetBrains Mono', monospace; transition: all 0.15s; }
.rte-link-btn:hover { border-color: var(--accent); color: var(--accent); }
.rte-editor { min-height: 110px; padding: 10px 12px; outline: none; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.7; color: var(--text); background: transparent; caret-color: var(--accent); }
.rte-editor:empty::before { content: attr(data-placeholder); color: var(--muted2); pointer-events: none; }
.rte-editor a { color: var(--accent); text-decoration: underline; }
.rte-chip { display: none; align-items: center; gap: 4px; margin-left: 3px; font-size: 10px; color: var(--accent); background: var(--accent-glow); border-radius: 4px; padding: 2px 6px; max-width: 130px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.rte-chip.show { display: flex; }
.rte-unlink { cursor: pointer; color: var(--red); font-size: 11px; background: none; border: none; flex-shrink: 0; }

/* â”€â”€ LINK POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lp { display: none; position: fixed; z-index: 600; background: var(--s1); border: 1px solid var(--border); border-radius: 11px; padding: 14px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); width: 300px; flex-direction: column; gap: 9px; }
.lp.open { display: flex; }
.lp-title { font-family: 'Bricolage Grotesque', sans-serif; font-weight: 700; font-size: 12px; }
.lp-actions { display: flex; gap: 6px; justify-content: flex-end; }

/* â”€â”€ LINK CHECKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chk-area { background: var(--s2); border: 1px solid var(--border); border-radius: 9px; overflow: hidden; }
.chk-row { display: flex; align-items: center; gap: 9px; padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 11px; }
.chk-row:last-child { border-bottom: none; }
.chk-row:hover { background: var(--s3); }
.ci { width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; flex-shrink: 0; }
.ci-ok { background: var(--green-dim); color: var(--green); }
.ci-warn { background: var(--red-dim); color: var(--red); }
.ci-n { background: var(--s3); color: var(--muted); }
.chk-url { color: var(--muted); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.chk-url.bad { color: var(--red); }
.chk-tag { font-size: 9px; padding: 1px 6px; border-radius: 3px; background: var(--s3); color: var(--muted); flex-shrink: 0; }
.chk-tag.warn { background: var(--red-dim); color: var(--red); }
.chk-repair {
  font-size: 9px; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(255,176,32,0.3);
  background: var(--amber-dim); color: var(--amber); cursor: pointer; flex-shrink: 0;
  font-family: 'JetBrains Mono', monospace; transition: all 0.15s; white-space: nowrap;
}
.chk-repair:hover { background: rgba(255,176,32,0.25); border-color: var(--amber); }

/* Segment list */
.seg-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }
.seg-row { display: flex; align-items: center; gap: 6px; }
.seg-row input { flex: 1; }
.seg-del { width: 26px; height: 26px; border-radius: 5px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; }
.seg-del:hover { background: var(--red-dim); color: var(--red); border-color: rgba(255,69,96,0.3); }
.seg-add { font-size: 10px; color: var(--accent); background: var(--accent-glow); border: 1px solid rgba(61,110,255,0.2); border-radius: 5px; padding: 3px 10px; cursor: pointer; transition: all 0.15s; font-family: 'JetBrains Mono', monospace; display: inline-flex; align-items: center; gap: 4px; }
.seg-add:hover { background: rgba(61,110,255,0.2); }

/* â”€â”€ Block composer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.block-stack { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }

.email-block {
  background: var(--s1); border: 1px solid var(--border); border-radius: 10px;
  overflow: hidden; transition: border-color 0.15s;
}
.email-block:hover { border-color: var(--border2); }

.block-header {
  display: flex; align-items: center; gap: 8px; padding: 8px 12px;
  background: var(--s2); border-bottom: 1px solid var(--border); user-select: none;
}
.block-type-pill {
  font-size: 9px; text-transform: uppercase; letter-spacing: 1px;
  padding: 2px 7px; border-radius: 3px; font-weight: 600;
}
.pill-text    { background: rgba(61,110,255,0.15);  color: var(--accent); }
.pill-image   { background: rgba(0,229,160,0.12);   color: var(--green); }
.pill-cta     { background: rgba(192,132,252,0.12); color: var(--vip); }
.pill-spacer  { background: rgba(255,176,32,0.12);  color: var(--amber); }

.block-move { background: none; border: none; color: var(--muted); cursor: pointer; padding: 2px 5px; border-radius: 4px; font-size: 12px; transition: all 0.15s; line-height: 1; }
.block-move:hover { background: var(--s3); color: var(--text); }
.block-move:disabled { opacity: 0.2; cursor: default; }
.block-del { margin-left: auto; background: none; border: none; color: var(--muted); cursor: pointer; padding: 2px 6px; border-radius: 4px; font-size: 14px; transition: all 0.15s; line-height: 1; }
.block-del:hover { background: var(--red-dim); color: var(--red); }

.block-body { padding: 12px 14px; }

/* Add block button */
.add-block-wrap { position: relative; display: inline-block; }
.add-block-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 14px; border-radius: 7px; border: 1px dashed var(--border2);
  background: transparent; color: var(--muted); cursor: pointer; font-size: 11px;
  font-family: 'JetBrains Mono', monospace; transition: all 0.2s; width: 100%;
  justify-content: center;
}
.add-block-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
.add-block-menu {
  display: none; position: absolute; bottom: calc(100% + 6px); left: 0;
  background: var(--s1); border: 1px solid var(--border); border-radius: 10px;
  padding: 5px; min-width: 180px; box-shadow: 0 12px 40px rgba(0,0,0,0.5); z-index: 100;
}
.add-block-menu.open { display: block; }
.abm-item {
  display: flex; align-items: center; gap: 9px; padding: 8px 10px; border-radius: 6px;
  cursor: pointer; font-size: 12px; color: var(--muted); transition: all 0.12s;
  font-family: 'JetBrains Mono', monospace;
}
.abm-item:hover { background: var(--s2); color: var(--text); }
.abm-icon { font-size: 14px; width: 20px; text-align: center; }

/* Layout templates */
.lt-bar { display: flex; align-items: center; gap: 8px; padding: 12px 14px; background: var(--s2); border: 1px solid var(--border); border-radius: 9px; margin-bottom: 14px; flex-wrap: wrap; }
.lt-tag { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); white-space: nowrap; }
.lt-chips { display: flex; gap: 5px; flex-wrap: wrap; flex: 1; }
.lt-chip {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 5px; font-size: 10px;
  background: var(--s3); border: 1px solid var(--border); color: var(--text);
  cursor: pointer; transition: all 0.15s; font-family: 'JetBrains Mono', monospace;
}
.lt-chip:hover { border-color: var(--accent); color: var(--accent); }
.lt-chip-del { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 12px; padding: 0; line-height: 1; transition: color 0.15s; }
.lt-chip-del:hover { color: var(--red); }
.lt-empty { font-size: 11px; color: var(--muted2); font-style: italic; }
.lt-save-wrap { display: flex; gap: 6px; align-items: center; }
.lt-save-wrap input { background: var(--bg); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-size: 11px; padding: 4px 9px; outline: none; font-family: 'JetBrains Mono', monospace; width: 140px; }
.lt-save-wrap input:focus { border-color: var(--accent); }

/* Structure preview pill row */
.struct-preview { display: flex; gap: 3px; align-items: center; flex-wrap: wrap; margin-left: auto; }
.sp-pill { font-size: 8px; padding: 1px 5px; border-radius: 3px; background: var(--s3); color: var(--muted); border: 1px solid var(--border); }
.sp-pill.t { background: rgba(61,110,255,0.1);  color: var(--accent); border-color: rgba(61,110,255,0.2); }
.sp-pill.i { background: rgba(0,229,160,0.08);  color: var(--green);  border-color: rgba(0,229,160,0.15); }
.sp-pill.c { background: rgba(192,132,252,0.1); color: var(--vip);    border-color: rgba(192,132,252,0.2); }
.sp-pill.s { background: rgba(255,176,32,0.08); color: var(--amber);  border-color: rgba(255,176,32,0.15); }

/* â”€â”€ OUTPUT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 200; align-items: center; justify-content: center; padding: 16px; }
.overlay.open { display: flex; }
.modal { background: var(--s1); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 900px; max-height: 94vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 40px 80px rgba(0,0,0,0.6); }
.modal-top { padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.modal-title { font-family: 'Bricolage Grotesque', sans-serif; font-weight: 700; font-size: 15px; }
.modal-tabs-row { padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 4px; flex-wrap: wrap; flex-shrink: 0; }
.out-tab { padding: 4px 12px; border-radius: 5px; font-size: 10px; cursor: pointer; border: 1px solid var(--border); background: transparent; color: var(--muted); font-family: 'JetBrains Mono', monospace; transition: all 0.15s; display: flex; align-items: center; gap: 4px; }
.out-tab.active { background: var(--accent); border-color: var(--accent); color: white; }
.out-tab.vip-tab.active { background: var(--vip); border-color: var(--vip); }
.modal-body { flex: 1; overflow: auto; padding: 20px; }
.out-sec { display: none; } .out-sec.active { display: block; }
.meta-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap: 8px; margin-bottom: 16px; }
.mp { background: var(--s2); border: 1px solid var(--border); border-radius: 7px; padding: 8px 12px; }
.mp-l { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
.mp-v { font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.close-x { margin-left: auto; background: transparent; border: none; color: var(--muted); font-size: 20px; cursor: pointer; padding: 2px 5px; border-radius: 5px; transition: all 0.15s; line-height: 1; }
.close-x:hover { color: var(--text); background: var(--s2); }
.code-block { background: var(--bg); border: 1px solid var(--border); border-radius: 7px; padding: 12px; font-size: 10px; line-height: 1.7; white-space: pre-wrap; word-break: break-all; color: var(--muted); max-height: 320px; overflow: auto; margin-top: 8px; }
.spin { width: 13px; height: 13px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .8s linear infinite; flex-shrink: 0; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast { position: fixed; bottom: 20px; right: 20px; padding: 9px 14px; border-radius: 9px; font-size: 11px; z-index: 9998; transform: translateY(12px); opacity: 0; transition: all 0.25s; pointer-events: none; }
.toast.show { transform: translateY(0); opacity: 1; }
.t-ok { background: var(--green-dim); border: 1px solid rgba(0,229,160,0.3); color: var(--green); }
.t-err { background: var(--red-dim); border: 1px solid rgba(255,69,96,0.3); color: var(--red); }

/* â”€â”€ NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notes-block { background: var(--amber-dim); border: 1px solid rgba(255,176,32,0.2); border-radius: 9px; padding: 12px 14px; margin-bottom: 14px; }

/* Subject counter */
.subj-wrap { position: relative; }
.subj-count {
  position: absolute; right: 9px; top: 50%; transform: translateY(-50%);
  font-size: 10px; color: var(--muted); pointer-events: none;
  font-family: 'JetBrains Mono', monospace; transition: color 0.2s;
}
.subj-count.warn { color: var(--amber); }
.subj-count.over { color: var(--red); font-weight: 700; }
.subj-wrap input { padding-right: 44px; }

/* Copy-from button */
.copy-from-btn {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 10px; color: var(--muted); background: var(--s2);
  border: 1px solid var(--border); border-radius: 5px;
  padding: 3px 9px; cursor: pointer; transition: all 0.15s;
  font-family: 'JetBrains Mono', monospace; margin-bottom: 12px;
}
.copy-from-btn:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-glow); }

/* â”€â”€ LOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lock-screen { position: fixed; inset: 0; z-index: 10000; background: var(--bg); display: flex; align-items: center; justify-content: center; }
.lock-screen::before { content: ''; position: absolute; inset: 0; background-image: linear-gradient(rgba(61,110,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(61,110,255,0.04) 1px,transparent 1px); background-size: 40px 40px; pointer-events: none; }
.l-orb { position: absolute; border-radius: 50%; filter: blur(90px); pointer-events: none; opacity: 0.12; }
.l-orb-1 { width: 450px; height: 450px; background: var(--accent); top: -140px; right: -80px; }
.l-orb-2 { width: 380px; height: 380px; background: #ff4560; bottom: -130px; left: -80px; }
.lock-box { position: relative; z-index: 1; background: var(--s1); border: 1px solid var(--border); border-radius: 18px; padding: 40px 34px 32px; width: 100%; max-width: 360px; box-shadow: 0 40px 70px rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; }
.l-icon { width: 48px; height: 48px; background: var(--accent-glow); border: 1px solid rgba(61,110,255,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 16px; }
.l-title { font-family: 'Bricolage Grotesque', sans-serif; font-weight: 800; font-size: 20px; letter-spacing: -0.5px; margin-bottom: 4px; }
.l-sub { font-size: 11px; color: var(--muted); margin-bottom: 22px; text-align: center; line-height: 1.6; }
.l-inp-wrap { position: relative; width: 100%; margin-bottom: 9px; }
.l-inp { width: 100%; background: var(--s2); border: 1px solid var(--border); border-radius: 9px; color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 14px; padding: 11px 40px 11px 14px; outline: none; letter-spacing: 2px; transition: border-color 0.2s; text-align: center; }
.l-inp:focus { border-color: var(--accent); background: var(--s3); }
.l-inp.shake { animation: shake .4s ease; border-color: var(--red) !important; }
@keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-7px)} 40%{transform:translateX(7px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
.l-eye { position: absolute; right: 11px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--muted); cursor: pointer; font-size: 14px; }
.l-err { font-size: 11px; color: var(--red); min-height: 15px; text-align: center; margin-bottom: 8px; }
.l-btn { width: 100%; padding: 11px; border-radius: 9px; background: var(--accent); color: white; font-family: 'Bricolage Grotesque', sans-serif; font-weight: 700; font-size: 14px; border: none; cursor: pointer; box-shadow: 0 0 20px var(--accent-glow); transition: all 0.15s; margin-bottom: 12px; }
.l-btn:hover { background: #5580ff; transform: translateY(-1px); }
.l-note { font-size: 11px; color: var(--muted); text-align: center; line-height: 1.7; }
.lock-screen.gone { display: none; }

/* â”€â”€ PW BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pw-bar { display: none; align-items: center; gap: 7px; padding: 4px 9px; background: var(--s2); border: 1px solid var(--border); border-radius: 7px; }
.pw-bar.open { display: flex; }
.pw-bar input { background: var(--bg); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-size: 11px; padding: 4px 8px; width: 120px; outline: none; font-family: 'JetBrains Mono', monospace; letter-spacing: 1px; }
.pw-bar input:focus { border-color: var(--accent); }
.pw-bar-lbl { font-size: 10px; color: var(--muted); white-space: nowrap; }

@media (max-width: 600px) {
  .panel { padding: 16px 12px 60px; }
  .g2, .g3, .g4 { grid-template-columns: 1fr; }
  .s2, .s3, .sa { grid-column: 1; }
  .camp-wrap { max-width: 160px; }
  .topbar-right .badge { display: none; }
}
</style>
</head>
<body>

<!-- LOCK SCREEN -->
<div class="lock-screen" id="lockScreen">
  <div class="l-orb l-orb-1"></div>
  <div class="l-orb l-orb-2"></div>
  <div class="lock-box">
    <div class="l-icon">ğŸ”</div>
    <div class="l-title">Email<span style="color:var(--accent)">Hub</span></div>
    <div class="l-sub" id="lSub">Enter your password to continue</div>
    <div class="l-inp-wrap">
      <input class="l-inp" type="password" id="lInp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
        onkeydown="if(event.key==='Enter')tryUnlock()"
        oninput="document.getElementById('lErr').textContent=''">
      <button class="l-eye" onclick="toggleEye()">ğŸ‘</button>
    </div>
    <div class="l-err" id="lErr"></div>
    <button class="l-btn" onclick="tryUnlock()">Unlock</button>
    <div class="l-note" id="lNote"></div>
  </div>
</div>

<!-- APP -->
<div id="appShell" style="display:none;">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="logo"><div class="logo-dot"></div>Email<span>Hub</span></div>
    <div class="tsep"></div>
    <div class="camp-wrap">
      <span class="camp-label">Campaign</span>
      <input class="camp-input" id="campaignName" type="text" placeholder="Summer Sale â€” Week 1">
    </div>
    <div class="topbar-right">
      <span class="badge vip-badge" id="vipBadge">â­ VIP ON</span>
      <span class="badge" id="readyBadge">0 / 6 ready</span>
      <div class="pw-bar" id="pwBar">
        <span class="pw-bar-lbl">New pw</span>
        <input type="password" id="newPw" placeholder="min 6 chars" onkeydown="if(event.key==='Enter')savePw()">
        <button class="btn btn-green btn-sm" onclick="savePw()">Save</button>
        <button class="btn btn-ghost btn-sm" onclick="togglePwBar()">âœ•</button>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="togglePwBar()" title="Change password">ğŸ”‘</button>
      <button class="btn btn-ghost btn-sm" onclick="lockApp()">ğŸ”’</button>
      <button class="btn btn-primary btn-sm" onclick="openOutput()">âš¡ Generate & Push</button>
    </div>
  </div>

  <!-- MAIN NAV -->
  <div class="mainnav" id="mainNav">
    <button class="mnav-tab active" data-panel="content" onclick="goPanel('content')">
      <span class="ni">âœï¸</span> Content
    </button>
    <button class="mnav-tab" data-panel="links" onclick="goPanel('links')">
      <span class="ni">ğŸ”—</span> Links
    </button>
    <div style="width:1px;height:18px;background:var(--border);margin:0 6px;align-self:center;"></div>
    <button class="mnav-tab" data-panel="store-us" onclick="goPanel('store-us')" id="snav-us">
      <div class="store-dot" style="background:var(--us)"></div> US
    </button>
    <button class="mnav-tab" data-panel="store-uk" onclick="goPanel('store-uk')" id="snav-uk">
      <div class="store-dot" style="background:var(--uk)"></div> UK
    </button>
    <button class="mnav-tab" data-panel="store-cz" onclick="goPanel('store-cz')" id="snav-cz">
      <div class="store-dot" style="background:var(--cz)"></div> CZ
    </button>
    <button class="mnav-tab" data-panel="store-de" onclick="goPanel('store-de')" id="snav-de">
      <div class="store-dot" style="background:var(--de)"></div> DE
    </button>
    <button class="mnav-tab" data-panel="store-eu" onclick="goPanel('store-eu')" id="snav-eu">
      <div class="store-dot" style="background:var(--eu)"></div> EU
    </button>
    <button class="mnav-tab" data-panel="store-sg" onclick="goPanel('store-sg')" id="snav-sg">
      <div class="store-dot" style="background:var(--sg)"></div> SG
    </button>
  </div>

  <!-- APP BODY -->
  <div class="app-body">

    <!-- CONTENT PANEL -->
    <div class="panel active" id="panel-content">
      <div style="margin-bottom:16px;">
        <div style="font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:18px;margin-bottom:3px;">Campaign Content</div>
        <div style="font-size:11px;color:var(--muted);">4 regional variants â€” US Â· UK (+EU,SG) Â· CZ Â· DE</div>
      </div>

      <!-- Banner note -->
      <div class="notes-block">
        <div class="field-label" style="color:var(--amber);margin-bottom:6px;">ğŸ–¼ï¸ Banner reminder</div>
        <input type="text" id="bannerNote" placeholder="e.g. Use hero-summer.jpg â€” add banners in Klaviyo after pushing" style="background:rgba(255,176,32,0.06);border-color:rgba(255,176,32,0.2);color:var(--amber);">
      </div>

      <!-- Campaign toggles -->
      <div class="card">
        <div class="card-body" style="padding:12px 16px;display:flex;flex-direction:column;gap:10px;">
          <div class="toggle-row">
            <div class="tog" id="discTog" onclick="toggleDiscount()"></div>
            <span class="tog-label">Include discount code</span>
            <span class="tog-sub">Per campaign</span>
          </div>
          <div style="height:1px;background:var(--border);"></div>
          <div class="toggle-row">
            <div class="tog" id="vipTog" onclick="toggleVip()"></div>
            <span class="tog-label" style="font-weight:600;">â­ VIP mode â€” separate campaign with different links, subject & list</span>
            <span class="tog-sub">Doubles to 12 pushes</span>
          </div>
        </div>
      </div>

      <!-- Layout templates -->
      <div class="lt-bar" id="ltBar">
        <span class="lt-tag">ğŸ“ Layouts</span>
        <div class="lt-chips" id="ltChips"></div>
        <div class="lt-save-wrap">
          <input type="text" id="ltNameInput" placeholder="Name this layoutâ€¦" onkeydown="if(event.key==='Enter')saveLayout()">
          <button class="btn btn-ghost btn-sm" onclick="saveLayout()">Save</button>
        </div>
      </div>

      <!-- Region tabs -->
      <div class="rtabs">
        <button class="rtab active" id="rtab-us" onclick="goRegion('us')" style="--rc:var(--us)"><div class="rdot"></div>ğŸ‡ºğŸ‡¸ US</button>
        <button class="rtab" id="rtab-uk" onclick="goRegion('uk')" style="--rc:var(--uk)"><div class="rdot"></div>ğŸ‡¬ğŸ‡§ UK <span style="font-size:9px;opacity:0.5;">+EUÂ·SG</span></button>
        <button class="rtab" id="rtab-cs" onclick="goRegion('cs')" style="--rc:var(--cz)"><div class="rdot"></div>ğŸ‡¨ğŸ‡¿ CZ</button>
        <button class="rtab" id="rtab-de" onclick="goRegion('de')" style="--rc:var(--de)"><div class="rdot"></div>ğŸ‡©ğŸ‡ª DE</button>
      </div>

      <div id="rpanel-us" class="rpanel active"><div id="cform-us"></div></div>
      <div id="rpanel-uk" class="rpanel"><div id="cform-uk"></div></div>
      <div id="rpanel-cs" class="rpanel"><div id="cform-cs"></div></div>
      <div id="rpanel-de" class="rpanel"><div id="cform-de"></div></div>
    </div>

    <!-- LINK CHECKER PANEL -->
    <div class="panel" id="panel-links">
      <div style="margin-bottom:16px;"><div style="font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:18px;margin-bottom:3px;">Link Checker</div><div style="font-size:11px;color:var(--muted);">Validates every link against expected domain per store</div></div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
        <button class="btn btn-primary btn-sm" onclick="runLinkCheck()">ğŸ” Run Check</button>
        <span style="font-size:11px;color:var(--muted);" id="linkSummary">Press Run to check</span>
      </div>
      <div id="linkResults"></div>
    </div>

    <!-- STORE PANELS (one per store, in main nav) -->
    <div id="storePanelsMount"></div>

  </div>
</div>

<!-- OUTPUT MODAL -->
<div class="overlay" id="outputModal">
  <div class="modal">
    <div class="modal-top">
      <div class="modal-title">ğŸ“¬ Generated Campaigns</div>
      <button class="btn btn-green btn-sm" id="pushAllBtn" onclick="pushAll()" style="margin-left:8px;">âš¡ Push All</button>
      <span id="pushAllStatus" style="font-size:10px;color:var(--muted);margin-left:6px;"></span>
      <button class="close-x" onclick="closeOutput()">Ã—</button>
    </div>
    <div class="modal-tabs-row" id="outTabs"></div>
    <div class="modal-body" id="outBody"></div>
  </div>
</div>

<!-- Link popup -->
<div class="lp" id="linkPopup">
  <div class="lp-title">ğŸ”— Insert Link</div>
  <div class="field"><div class="field-label">Selected text</div><div id="lpSel" style="font-size:11px;color:var(--muted);padding:2px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div></div>
  <div class="field"><div class="field-label">URL</div><input type="text" id="lpUrl" placeholder="https://..." onkeydown="if(event.key==='Enter')applyLink()"></div>
  <div class="lp-actions">
    <button class="btn btn-ghost btn-sm" onclick="closeLinkPopup()">Cancel</button>
    <button class="btn btn-primary btn-sm" onclick="applyLink()">Apply</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STORES = [
  { id:'us', label:'US', flag:'ğŸ‡ºğŸ‡¸', region:'us', domain:'.com',   color:'var(--us)' },
  { id:'uk', label:'UK', flag:'ğŸ‡¬ğŸ‡§', region:'uk', domain:'.uk',    color:'var(--uk)' },
  { id:'cz', label:'CZ', flag:'ğŸ‡¨ğŸ‡¿', region:'cs', domain:'.cz',   color:'var(--cz)' },
  { id:'de', label:'DE', flag:'ğŸ‡©ğŸ‡ª', region:'de', domain:'.de',   color:'var(--de)' },
  { id:'eu', label:'EU', flag:'ğŸ‡ªğŸ‡º', region:'uk', domain:'.eu',   color:'var(--eu)' },
  { id:'sg', label:'SG', flag:'ğŸ‡¸ğŸ‡¬', region:'uk', domain:'.sg',   color:'var(--sg)' },
];
const REGIONS = [
  { id:'us', label:'US', flag:'ğŸ‡ºğŸ‡¸', color:'var(--us)' },
  { id:'uk', label:'UK', flag:'ğŸ‡¬ğŸ‡§', color:'var(--uk)' },
  { id:'cs', label:'CZ', flag:'ğŸ‡¨ğŸ‡¿', color:'var(--cz)' },
  { id:'de', label:'DE', flag:'ğŸ‡©ğŸ‡ª', color:'var(--de)' },
];

function defCfg() { return { senderName:'', senderEmail:'', replyTo:'', apiKey:'', lists:[], vipLists:[], header:'', footer:'', textColor:'#444444', bodyBg:'#ffffff', fontFamily:'Inter' }; }

// Migrate old single-listId configs to arrays
function migrateCfg(cfg) {
  if (!cfg.lists) cfg.lists = cfg.listId ? [cfg.listId] : [];
  if (!cfg.vipLists) cfg.vipLists = cfg.vipListId ? [cfg.vipListId] : [];
  return cfg;
}

let storeCfgs = {};
STORES.forEach(s => { const sv = localStorage.getItem(`ehub5_${s.id}`); storeCfgs[s.id] = migrateCfg(sv ? JSON.parse(sv) : defCfg()); });

let globalFont        = localStorage.getItem('ehub5_font')    || 'Inter';
let globalLineHeight  = parseFloat(localStorage.getItem('ehub5_lh') || '1.7');
let globalPageBg      = localStorage.getItem('ehub5_page_bg') || '#f4f4f6';
let globalEmailBg     = localStorage.getItem('ehub5_email_bg') || '#ffffff';

// CTA button globals
let ctaBorderRadius = localStorage.getItem('ehub5_cta_radius') || '50px';
let ctaFontSize     = localStorage.getItem('ehub5_cta_fsize')  || '15';
let ctaPadding      = localStorage.getItem('ehub5_cta_pad')    || '13px 36px';
let ctaFontWeight   = localStorage.getItem('ehub5_cta_weight') || '700';
let ctaTextColor    = localStorage.getItem('ehub5_cta_color')  || '#ffffff';

let discountOn = false, vipOn = false;

// Block stacks â€” keyed by region id, each is array of {id, type, data}
const blockStacks = { us:[], uk:[], cs:[], de:[] };
let blockIdCounter = 0;
function newBlockId() { return `blk_${++blockIdCounter}`; }

// Layout templates â€” saved structures
let layoutTemplates = JSON.parse(localStorage.getItem('ehub5_layouts') || '[]');
let savedRange = null, activeLinkRegion = null;
let generated = {}, checkTimer = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function goPanel(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.mnav-tab').forEach(t => t.classList.remove('active'));
  const panel = document.getElementById(`panel-${id}`);
  if (panel) panel.classList.add('active');
  const tab = document.querySelector(`[data-panel="${id}"]`);
  if (tab) tab.classList.add('active');
}

function goRegion(id) {
  document.querySelectorAll('[id^="rtab-"]').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('[id^="rpanel-"]').forEach(p => p.classList.remove('active'));
  document.getElementById(`rtab-${id}`).classList.add('active');
  document.getElementById(`rpanel-${id}`).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTENT FORMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PH = {
  us:{ subject:'e.g. Your summer favorites are here', preheader:'Free shipping on orders over $50', body:'Write your US copy here...', cta:'Shop Now', ctalink:'https://yourstore.com/sale', discount:'SUMMER20' },
  uk:{ subject:'e.g. Your summer favourites are here', preheader:'Free delivery on orders over Â£50', body:'Write your UK copy here...', cta:'Shop Now', ctalink:'https://yourstore.uk/sale', discount:'SUMMER20' },
  cs:{ subject:'e.g. VaÅ¡e letnÃ­ oblÃ­benÃ© kousky', preheader:'Doprava zdarma nad 1 000 KÄ', body:'NapiÅ¡te ÄeskÃ½ text zde...', cta:'Nakoupit nynÃ­', ctalink:'https://yourstore.cz/vyprodej', discount:'LETO20' },
  de:{ subject:'e.g. Ihre Sommerklassiker sind da', preheader:'Kostenloser Versand ab 50 â‚¬', body:'E-Mail Text hier...', cta:'Jetzt kaufen', ctalink:'https://yourstore.de/sale', discount:'SOMMER20' },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BLOCK COMPOSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function makeRteToolbar(bid) {
  return `<div class="rte-tb" id="tb-${bid}">
    <button class="rte-btn" onmousedown="event.preventDefault();rteCmd('${bid}','bold')"><b>B</b></button>
    <button class="rte-btn" onmousedown="event.preventDefault();rteCmd('${bid}','italic')"><i style="font-style:italic">I</i></button>
    <button class="rte-btn" onmousedown="event.preventDefault();rteCmd('${bid}','underline')"><u>U</u></button>
    <div class="rte-sep"></div>
    <button class="rte-link-btn" onmousedown="event.preventDefault();openLP('${bid}')">ğŸ”— Link</button>
    <div class="rte-chip" id="chip-${bid}"><span id="chip-txt-${bid}"></span><button class="rte-unlink" onmousedown="event.preventDefault();removeLink('${bid}')">Ã—</button></div>
    <div class="rte-sep"></div>
    <button class="rte-btn" onmousedown="event.preventDefault();rteCmd('${bid}','removeFormat')" style="font-size:9px;width:auto;padding:0 5px;">âœ•fmt</button>
  </div>`;
}

function renderBlock(region, block, idx, total) {
  const { id, type } = block;
  const isFirst = idx === 0, isLast = idx === total - 1;
  const header = `<div class="block-header">
    <span class="block-type-pill pill-${type}">${{text:'âœ Text',image:'ğŸ–¼ Image',cta:'ğŸ”˜ CTA',spacer:'â†• Spacer'}[type]}</span>
    <button class="block-move" onclick="moveBlock('${region}','${id}',-1)" ${isFirst?'disabled':''}>â†‘</button>
    <button class="block-move" onclick="moveBlock('${region}','${id}',1)"  ${isLast ?'disabled':''}>â†“</button>
    <button class="block-del" onclick="deleteBlock('${region}','${id}')" title="Remove block">Ã—</button>
  </div>`;

  let body = '';
  if (type === 'text') {
    body = `<div class="block-body">
      <div class="rte-wrap">
        ${makeRteToolbar(id)}
        <div class="rte-editor" id="${id}-editor" contenteditable="true"
          data-placeholder="Write your copy hereâ€¦" oninput="scheduleCheck()">${block.data.html||''}</div>
      </div>
    </div>`;
  } else if (type === 'image') {
    body = `<div class="block-body">
      <div class="g2">
        <div class="field" style="grid-column:1/-1;">
          <div class="field-label">Image URL</div>
          <input type="text" id="${id}-src" value="${esc(block.data.src||'')}" placeholder="https://cdn.yourbrand.com/image.jpg" oninput="syncBlock('${region}','${id}')">
        </div>
        <div class="field">
          <div class="field-label">Alt Text</div>
          <input type="text" id="${id}-alt" value="${esc(block.data.alt||'')}" placeholder="Describe the image">
        </div>
        <div class="field">
          <div class="field-label">Width (px or %)</div>
          <input type="text" id="${id}-width" value="${esc(block.data.width||'100%')}" placeholder="100%">
        </div>
        <div class="field">
          <div class="field-label">Link URL (optional)</div>
          <input type="text" id="${id}-link" value="${esc(block.data.link||'')}" placeholder="https://â€¦" oninput="scheduleCheck()">
        </div>
        <div class="field">
          <div class="field-label">Padding (top bottom)</div>
          <input type="text" id="${id}-pad" value="${esc(block.data.pad||'12px 0')}" placeholder="12px 0">
        </div>
      </div>
      ${block.data.src ? `<div style="margin-top:10px;text-align:center;"><img src="${esc(block.data.src)}" alt="${esc(block.data.alt||'')}" style="max-width:100%;max-height:120px;border-radius:6px;opacity:0.8;"></div>` : ''}
    </div>`;
  } else if (type === 'cta') {
    body = `<div class="block-body">
      <div class="g2">
        <div class="field">
          <div class="field-label">Button Text</div>
          <input type="text" id="${id}-text" value="${esc(block.data.text||'')}" placeholder="Shop Now">
        </div>
        <div class="field">
          <div class="field-label">Button Link</div>
          <input type="text" id="${id}-href" value="${esc(block.data.href||'')}" placeholder="https://â€¦" oninput="scheduleCheck()">
        </div>
      </div>
      <div style="margin-top:10px;text-align:center;">
        <span style="display:inline-block;background:#3d6eff;color:${ctaTextColor};padding:${ctaPadding};border-radius:${ctaBorderRadius};font-size:${ctaFontSize}px;font-weight:${ctaFontWeight};">${block.data.text||'Button text'}</span>
      </div>
    </div>`;
  } else if (type === 'spacer') {
    body = `<div class="block-body">
      <div class="field" style="max-width:160px;">
        <div class="field-label">Height (px)</div>
        <input type="number" id="${id}-height" value="${block.data.height||24}" min="4" max="120" placeholder="24">
      </div>
    </div>`;
  }

  const el = document.createElement('div');
  el.className = 'email-block'; el.id = `block-${id}`;
  el.innerHTML = header + body;
  return el;
}

function renderBlockStack(region) {
  const stack = blockStacks[region];
  const container = document.getElementById(`stack-${region}`);
  if (!container) return;
  container.innerHTML = '';
  stack.forEach((block, idx) => container.appendChild(renderBlock(region, block, idx, stack.length)));
  // Update structure preview pills in card header
  const sp = document.getElementById(`sp-${region}`);
  if (sp) sp.innerHTML = structurePills(stack);
}

function addBlock(region, type) {
  closeAllBlockMenus();
  const id = newBlockId();
  const defaults = { text:{html:''}, image:{src:'',alt:'',width:'100%',link:'',pad:'12px 0'}, cta:{text:'',href:''}, spacer:{height:24} };
  blockStacks[region].push({ id, type, data: {...defaults[type]} });
  renderBlockStack(region);
  // Scroll new block into view
  setTimeout(() => { const el = document.getElementById(`block-${id}`); if (el) el.scrollIntoView({ behavior:'smooth', block:'nearest' }); }, 50);
}

function deleteBlock(region, id) {
  blockStacks[region] = blockStacks[region].filter(b => b.id !== id);
  renderBlockStack(region);
}

function moveBlock(region, id, dir) {
  const stack = blockStacks[region];
  const idx = stack.findIndex(b => b.id === id);
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= stack.length) return;
  // Save current input state before re-render
  saveBlockInputs(region);
  [stack[idx], stack[newIdx]] = [stack[newIdx], stack[idx]];
  renderBlockStack(region);
}

function saveBlockInputs(region) {
  // Snapshot current DOM values back into blockStacks data before any re-render
  blockStacks[region].forEach(block => {
    const { id, type } = block;
    if (type === 'text') {
      const ed = document.getElementById(`${id}-editor`);
      if (ed) block.data.html = ed.innerHTML;
    } else if (type === 'image') {
      ['src','alt','width','link','pad'].forEach(k => { const el = document.getElementById(`${id}-${k}`); if (el) block.data[k] = el.value; });
    } else if (type === 'cta') {
      ['text','href'].forEach(k => { const el = document.getElementById(`${id}-${k}`); if (el) block.data[k] = el.value; });
    } else if (type === 'spacer') {
      const el = document.getElementById(`${id}-height`); if (el) block.data.height = el.value;
    }
  });
}

function syncBlock(region, id) {
  // Live-sync image src for preview without full re-render
  const block = blockStacks[region].find(b => b.id === id);
  if (!block) return;
  const srcEl = document.getElementById(`${id}-src`);
  if (srcEl) block.data.src = srcEl.value;
}

function toggleBlockMenu(region) {
  const menu = document.getElementById(`abm-${region}`);
  if (!menu) return;
  const wasOpen = menu.classList.contains('open');
  closeAllBlockMenus();
  if (!wasOpen) menu.classList.add('open');
}

function closeAllBlockMenus() {
  document.querySelectorAll('.add-block-menu').forEach(m => m.classList.remove('open'));
}

document.addEventListener('click', e => {
  if (!e.target.closest('.add-block-wrap')) closeAllBlockMenus();
});

// â”€â”€ Layout Templates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function structurePills(blocks) {
  const abbr = { text:'T', image:'I', cta:'C', spacer:'S' };
  const cls  = { text:'t', image:'i', cta:'c', spacer:'s' };
  return blocks.map(b => `<span class="sp-pill ${cls[b.type]||''}">${abbr[b.type]||'?'}</span>`).join('');
}

function renderLayoutChips() {
  const wrap = document.getElementById('ltChips');
  if (!wrap) return;
  if (!layoutTemplates.length) {
    wrap.innerHTML = `<span class="lt-empty">No saved layouts yet â€” build a block structure and save it</span>`;
    return;
  }
  wrap.innerHTML = layoutTemplates.map((lt, i) =>
    `<span class="lt-chip" onclick="loadLayout(${i})" title="Load: ${lt.name}">
      ${esc(lt.name)}
      <span class="struct-preview" style="margin-left:4px;">${structurePills(lt.blocks)}</span>
      <button class="lt-chip-del" onclick="event.stopPropagation();deleteLayout(${i})" title="Delete">Ã—</button>
    </span>`
  ).join('');
}

function saveLayout() {
  saveBlockInputs('us'); // snapshot current region (use active region)
  const activeRegion = document.querySelector('.rtab.active')?.id?.replace('rtab-','') || 'us';
  saveBlockInputs(activeRegion);
  const blocks = blockStacks[activeRegion];
  if (!blocks.length) { showToast('âš ï¸ Add some blocks first', 'err'); return; }
  const nameEl = document.getElementById('ltNameInput');
  const name = nameEl.value.trim() || `Layout ${layoutTemplates.length + 1}`;
  // Save structure only â€” block types and image/spacer data (no text content)
  const structure = blocks.map(b => ({
    type: b.type,
    data: b.type === 'image'  ? { src:'', alt:'', width: b.data.width || '100%', link:'', pad: b.data.pad || '12px 0' }
        : b.type === 'spacer' ? { height: b.data.height }
        : b.type === 'cta'    ? { text:'', href:'' }
        : { html:'' }
  }));
  layoutTemplates.push({ name, blocks: structure });
  localStorage.setItem('ehub5_layouts', JSON.stringify(layoutTemplates));
  nameEl.value = '';
  renderLayoutChips();
  showToast(`âœ… Layout "${name}" saved!`, 'ok');
}

function loadLayout(idx) {
  const lt = layoutTemplates[idx];
  if (!lt) return;
  const activeRegion = document.querySelector('.rtab.active')?.id?.replace('rtab-','') || 'us';
  if (!confirm(`Load "${lt.name}" into ${activeRegion.toUpperCase()}? Current blocks will be replaced.`)) return;
  blockStacks[activeRegion] = lt.blocks.map(b => ({ id: newBlockId(), type: b.type, data: JSON.parse(JSON.stringify(b.data)) }));
  renderBlockStack(activeRegion);
  showToast(`âœ… "${lt.name}" loaded into ${activeRegion.toUpperCase()}`, 'ok');
}

function deleteLayout(idx) {
  const name = layoutTemplates[idx]?.name || '';
  if (!confirm(`Delete layout "${name}"?`)) return;
  layoutTemplates.splice(idx, 1);
  localStorage.setItem('ehub5_layouts', JSON.stringify(layoutTemplates));
  renderLayoutChips();
  showToast(`ğŸ—‘ "${name}" deleted`, 'ok');
}

function applyStructureToAll(sourceRegion) {
  saveBlockInputs(sourceRegion);
  const source = blockStacks[sourceRegion];
  if (!source.length) { showToast('âš ï¸ No blocks to copy', 'err'); return; }
  const others = Object.keys(blockStacks).filter(r => r !== sourceRegion);
  if (!confirm(`Copy block structure from ${sourceRegion.toUpperCase()} to ${others.map(r=>r.toUpperCase()).join(', ')}?\n\nBlock types will be copied, text content will be cleared.`)) return;
  others.forEach(region => {
    blockStacks[region] = source.map(b => ({
      id: newBlockId(),
      type: b.type,
      data: b.type === 'image'  ? { src: b.data.src || '', alt:'', width: b.data.width || '100%', link:'', pad: b.data.pad || '12px 0' }
          : b.type === 'spacer' ? { height: b.data.height }
          : b.type === 'cta'    ? { text:'', href:'' }
          : { html:'' } // text blocks get empty content
    }));
    // Only re-render if the region panel is mounted
    const el = document.getElementById(`stack-${region}`);
    if (el) renderBlockStack(region);
  });
  showToast(`âŠ• Structure applied to ${others.map(r=>r.toUpperCase()).join(', ')}`, 'ok');
}

// Get all block data for a region (snapshots DOM first)
function getBlocksData(region) {
  saveBlockInputs(region);
  return blockStacks[region];
}

function buildContentForm(region) {
  const ph = PH[region];
  const hint = { us:'US only â€” .com links', uk:'UK, EU, SG â€” .uk / .eu / .sg links', cs:'CZ store â€” Czech', de:'DE store â€” German' }[region];
  const col = REGIONS.find(r=>r.id===region).color;
  const copyFromBtn = region === 'uk'
    ? `<button class="copy-from-btn" onclick="copyFromUS()">â†™ Copy from US</button>` : '';
  return `
  ${copyFromBtn}
  <div class="card">
    <div class="card-head"><div class="sbar" style="--sc:${col}"></div><div class="card-title">Subject & Preheader</div><span class="card-hint">${hint}</span></div>
    <div class="card-body">
      <div class="g2">
        <div class="field">
          <div class="field-label">Subject Line</div>
          <div class="subj-wrap">
            <input type="text" id="${region}-subject" placeholder="${ph.subject}" oninput="updateSubjCount('${region}',this.value)">
            <span class="subj-count" id="${region}-subj-count">0</span>
          </div>
        </div>
        <div class="field"><div class="field-label">Preheader</div><input type="text" id="${region}-preheader" placeholder="${ph.preheader}"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head">
      <div class="sbar" style="--sc:${col}"></div>
      <div class="card-title">Content Blocks</div>
      <div class="struct-preview" id="sp-${region}"></div>
      <button class="btn btn-ghost btn-sm" style="margin-left:8px;font-size:10px;" onclick="applyStructureToAll('${region}')" title="Copy block structure (not content) to all other regions">âŠ• Apply to all</button>
    </div>
    <div class="card-body">
      <div class="block-stack" id="stack-${region}"></div>
      <div class="add-block-wrap">
        <button class="add-block-btn" onclick="toggleBlockMenu('${region}')">+ Add block</button>
        <div class="add-block-menu" id="abm-${region}">
          <div class="abm-item" onclick="addBlock('${region}','text')"><span class="abm-icon">âœï¸</span> Text</div>
          <div class="abm-item" onclick="addBlock('${region}','image')"><span class="abm-icon">ğŸ–¼ï¸</span> Image</div>
          <div class="abm-item" onclick="addBlock('${region}','cta')"><span class="abm-icon">ğŸ”˜</span> CTA Button</div>
          <div class="abm-item" onclick="addBlock('${region}','spacer')"><span class="abm-icon">â†•ï¸</span> Spacer</div>
        </div>
      </div>
      <div id="disc-block-${region}" style="display:none;margin-top:12px;">
        <div class="field"><div class="field-label">Discount Code</div><input type="text" id="${region}-discount" placeholder="${ph.discount}"></div>
      </div>
    </div>
  </div>

  <!-- VIP SECTION -->
  <div class="vip-section" id="vip-${region}">
    <div class="vip-card">
      <div class="vip-title">â­ VIP Campaign â€” ${hint}</div>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <div class="g2">
          <div class="field">
            <div class="field-label">VIP Subject Line</div>
            <div class="subj-wrap">
              <input type="text" id="${region}-vip-subject" placeholder="VIP early access: ${ph.subject.replace('e.g. ','')}" oninput="updateSubjCount('${region}-vip',this.value)">
              <span class="subj-count" id="${region}-vip-subj-count">0</span>
            </div>
          </div>
          <div class="field"><div class="field-label">VIP Preheader</div><input type="text" id="${region}-vip-preheader" placeholder="Exclusive VIP access..."></div>
        </div>
        <div class="field"><div class="field-label">VIP CTA Link <span style="font-size:9px;color:var(--muted);">(swaps all CTA block links)</span></div><input type="text" id="${region}-vip-ctalink" placeholder="${ph.ctalink.replace('/sale','/vip-sale')}" oninput="scheduleCheck()"></div>
        <div class="field" style="background:var(--vip-dim);border:1px solid rgba(192,132,252,0.15);border-radius:7px;padding:10px;">
          <div class="field-label" style="color:var(--vip);">VIP List ID override</div>
          <div style="font-size:10px;color:var(--muted);margin-bottom:6px;margin-top:2px;">Leave blank to use each store's VIP list ID from store config</div>
          <input type="text" id="${region}-vip-listid" placeholder="Optional â€” overrides store default">
        </div>
      </div>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORE PANELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderStorePanels() {
  const mount = document.getElementById('storePanelsMount');

  mount.innerHTML = STORES.map(s => {
    const c = storeCfgs[s.id];
    return `<div class="panel" id="panel-store-${s.id}">
      <div style="margin-bottom:16px;display:flex;align-items:center;gap:10px;">
        <div>
          <div style="font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:18px;">${s.flag} ${s.label} Store</div>
          <div style="font-size:11px;color:var(--muted);">Domain: <strong>${s.domain}</strong> Â· Region: <strong>${s.region.toUpperCase()}</strong></div>
        </div>
        <button class="btn btn-green btn-sm" style="margin-left:auto;" onclick="saveStore('${s.id}')">ğŸ’¾ Save ${s.label}</button>
      </div>

      <div class="notes-block" style="font-size:11px;">
        ğŸ”‘ <strong>API key for ${s.label}</strong> is stored securely as a Netlify environment variable <code style="background:var(--s3);padding:1px 5px;border-radius:3px;">KLAVIYO_KEY_${s.id.toUpperCase()}</code> â€” never in the browser.
      </div>

      <div class="card">
        <div class="card-head"><div class="sbar" style="--sc:${s.color}"></div><div class="card-title">Sender Details</div></div>
        <div class="card-body">
          <div class="g3">
            <div class="field"><div class="field-label">Sender Name</div><input type="text" id="sc-${s.id}-senderName" value="${esc(c.senderName)}" placeholder="Brand ${s.label}"></div>
            <div class="field"><div class="field-label">Sender Email</div><input type="email" id="sc-${s.id}-senderEmail" value="${esc(c.senderEmail)}" placeholder="hello@yourstore${s.domain}"></div>
            <div class="field"><div class="field-label">Reply-To</div><input type="email" id="sc-${s.id}-replyTo" value="${esc(c.replyTo)}" placeholder="support@yourstore${s.domain}"></div>
          </div>
        </div>
      </div>
        <div class="card-head"><div class="sbar" style="--sc:${s.color}"></div><div class="card-title">Body Formatting</div><span class="card-hint">Per store â€” saved permanently</span></div>
        <div class="card-body">
          <div class="g2">
            <div class="field">
              <div class="field-label">Body Text Color</div>
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="color" id="sc-${s.id}-textColor" value="${c.textColor||'#444444'}" style="width:44px;flex-shrink:0;" oninput="document.getElementById('sc-${s.id}-textColor-t').value=this.value">
                <input type="text" id="sc-${s.id}-textColor-t" value="${c.textColor||'#444444'}" style="flex:1;" placeholder="#444444" oninput="if(/^#[0-9a-fA-F]{6}$/.test(this.value))document.getElementById('sc-${s.id}-textColor').value=this.value">
              </div>
            </div>
            <div class="field">
              <div class="field-label">Body Background Color</div>
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="color" id="sc-${s.id}-bodyBg" value="${c.bodyBg||'#ffffff'}" style="width:44px;flex-shrink:0;" oninput="document.getElementById('sc-${s.id}-bodyBg-t').value=this.value">
                <input type="text" id="sc-${s.id}-bodyBg-t" value="${c.bodyBg||'#ffffff'}" style="flex:1;" placeholder="#ffffff" oninput="if(/^#[0-9a-fA-F]{6}$/.test(this.value))document.getElementById('sc-${s.id}-bodyBg').value=this.value">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><div class="sbar" style="--sc:${s.color}"></div><div class="card-title">Global Typography & CTA</div><span class="card-hint">Applies to all stores</span></div>
        <div class="card-body" style="display:flex;flex-direction:column;gap:14px;">
          <div class="g2">
            <div class="field">
              <div class="field-label">Email Font</div>
              <input type="text" id="globalFontInput" value="${globalFont}" placeholder="Inter, Arial, Georgiaâ€¦" oninput="setGlobalFont(this.value)">
              <div style="font-size:9px;color:var(--muted);margin-top:3px;">Exact name as used in Klaviyo, e.g. <em>Inter Normal 400</em></div>
            </div>
            <div class="field">
              <div class="field-label">Line Spacing</div>
              <input type="number" id="globalLhInput" value="${globalLineHeight}" min="1" max="3" step="0.1" oninput="setGlobalLh(this.value)" placeholder="1.7">
              <div style="font-size:9px;color:var(--muted);margin-top:3px;">Body paragraph line-height, e.g. 1.6 Â· 1.7 Â· 2.0</div>
            </div>
          </div>
          <div class="g2">
            <div class="field">
              <div class="field-label">Page Background Color</div>
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="color" id="globalPageBgPicker" value="${globalPageBg}" style="width:44px;flex-shrink:0;" oninput="document.getElementById('globalPageBgTxt').value=this.value;setGlobalBg('page',this.value)">
                <input type="text" id="globalPageBgTxt" value="${globalPageBg}" style="flex:1;" placeholder="#f4f4f6" oninput="if(/^#[0-9a-fA-F]{6}$/.test(this.value)){document.getElementById('globalPageBgPicker').value=this.value;setGlobalBg('page',this.value)}">
              </div>
              <div style="font-size:9px;color:var(--muted);margin-top:3px;">Outer wrapper â€” shown around email</div>
            </div>
            <div class="field">
              <div class="field-label">Email Container Background</div>
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="color" id="globalEmailBgPicker" value="${globalEmailBg}" style="width:44px;flex-shrink:0;" oninput="document.getElementById('globalEmailBgTxt').value=this.value;setGlobalBg('email',this.value)">
                <input type="text" id="globalEmailBgTxt" value="${globalEmailBg}" style="flex:1;" placeholder="#ffffff" oninput="if(/^#[0-9a-fA-F]{6}$/.test(this.value)){document.getElementById('globalEmailBgPicker').value=this.value;setGlobalBg('email',this.value)}">
              </div>
              <div style="font-size:9px;color:var(--muted);margin-top:3px;">Inner email card background</div>
            </div>
          </div>
          <div style="height:1px;background:var(--border);"></div>
          <div style="font-size:10px;color:var(--muted);letter-spacing:0.5px;text-transform:uppercase;">CTA Button</div>
          <div class="g3">
            <div class="field">
              <div class="field-label">Border Radius</div>
              <input type="text" id="globalCtaRadius" value="${ctaBorderRadius}" placeholder="50px" oninput="setCtaStyle('radius',this.value)">
              <div style="font-size:9px;color:var(--muted);margin-top:3px;">e.g. 4px Â· 8px Â· 50px (pill)</div>
            </div>
            <div class="field">
              <div class="field-label">Font Size (px)</div>
              <input type="number" id="globalCtaFsize" value="${ctaFontSize}" min="10" max="30" oninput="setCtaStyle('fsize',this.value)" placeholder="15">
            </div>
            <div class="field">
              <div class="field-label">Padding</div>
              <input type="text" id="globalCtaPad" value="${ctaPadding}" placeholder="13px 36px" oninput="setCtaStyle('pad',this.value)">
              <div style="font-size:9px;color:var(--muted);margin-top:3px;">vertical horizontal</div>
            </div>
            <div class="field">
              <div class="field-label">Font Weight</div>
              <input type="text" id="globalCtaWeight" value="${ctaFontWeight}" placeholder="700" oninput="setCtaStyle('weight',this.value)">
              <div style="font-size:9px;color:var(--muted);margin-top:3px;">400 normal Â· 700 bold Â· 800</div>
            </div>
            <div class="field">
              <div class="field-label">Text Color</div>
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="color" id="globalCtaColorPicker" value="${ctaTextColor}" style="width:44px;flex-shrink:0;" oninput="document.getElementById('globalCtaColorTxt').value=this.value;setCtaStyle('color',this.value)">
                <input type="text" id="globalCtaColorTxt" value="${ctaTextColor}" style="flex:1;" placeholder="#ffffff" oninput="if(/^#[0-9a-fA-F]{6}$/.test(this.value)){document.getElementById('globalCtaColorPicker').value=this.value;setCtaStyle('color',this.value)}">
              </div>
            </div>
          </div>
          <!-- Live preview -->
          <div style="padding:16px;background:var(--s2);border:1px solid var(--border);border-radius:8px;text-align:center;">
            <div style="font-size:10px;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;">Preview</div>
            <span id="ctaPreview" style="
              display:inline-block;
              background:#3d6eff;
              color:${ctaTextColor};
              padding:${ctaPadding};
              border-radius:${ctaBorderRadius};
              font-family:${globalFont},sans-serif;
              font-size:${ctaFontSize}px;
              font-weight:${ctaFontWeight};
              text-decoration:none;
              cursor:default;
            ">Shop Now</span>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');

  // Template panels
  tmplMount.innerHTML = STORES.map((s,i) => {
    const c = storeCfgs[s.id];
    return `<div id="tpanel-${s.id}" style="display:${i===0?'block':'none'}">
      <div style="display:flex;gap:6px;margin-bottom:12px;">
        ${STORES.map((ss,j)=>`<button class="btn btn-ghost btn-sm ${s.id===ss.id?'active':''}" onclick="switchTmpl('${ss.id}')" style="${s.id===ss.id?'border-color:var(--accent);color:var(--accent)':''}">${ss.flag} ${ss.label}</button>`).join('')}
      </div>
      <div class="card"><div class="card-head"><div class="sbar" style="--sc:${s.color}"></div><div class="card-title">${s.flag} ${s.label} â€” Header HTML</div></div>
        <div class="card-body"><div class="field"><div class="field-label">Everything above the body content</div>
          <textarea id="tmpl-${s.id}-header" rows="8" style="font-family:'JetBrains Mono',monospace;font-size:11px;background:var(--bg);" placeholder="<!-- Header HTML -->">${esc(c.header)}</textarea>
        </div></div>
      </div>
      <div class="card"><div class="card-head"><div class="sbar" style="--sc:${s.color}"></div><div class="card-title">${s.flag} ${s.label} â€” Footer HTML</div></div>
        <div class="card-body"><div class="field"><div class="field-label">Everything below the body content</div>
          <textarea id="tmpl-${s.id}-footer" rows="8" style="font-family:'JetBrains Mono',monospace;font-size:11px;background:var(--bg);" placeholder="<!-- Footer HTML -->">${esc(c.footer)}</textarea>
        </div></div>
      </div>
    </div>`;
  }).join('');
}

function switchTmpl(id) {
  STORES.forEach(s => {
    const el = document.getElementById(`tpanel-${s.id}`);
    if (el) el.style.display = s.id === id ? 'block' : 'none';
  });
}

function updateApiStatus(storeId) {
  const val = document.getElementById(`sc-${storeId}-apiKey`).value.trim();
  const el = document.getElementById(`api-status-${storeId}`);
  if (!el) return;
  el.className = `api-key-status ${val ? 'set' : 'missing'}`;
  el.textContent = val ? 'âœ… Set' : 'âš ï¸ Missing â€” required to push campaigns';
}

function setGlobalFont(font) {
  globalFont = font.trim();
  localStorage.setItem('ehub5_font', globalFont);
  document.querySelectorAll('#globalFontInput').forEach(el => { if (el.value !== globalFont) el.value = globalFont; });
  updateCtaPreview();
}

function setGlobalBg(which, val) {
  if (which === 'page')  { globalPageBg  = val; localStorage.setItem('ehub5_page_bg',  val); }
  if (which === 'email') { globalEmailBg = val; localStorage.setItem('ehub5_email_bg', val); }
  // Sync pickers/texts across any open panels
  document.querySelectorAll(`#globalPageBgPicker,#globalPageBgTxt`).forEach(el => { if (el.value !== globalPageBg) el.value = globalPageBg; });
  document.querySelectorAll(`#globalEmailBgPicker,#globalEmailBgTxt`).forEach(el => { if (el.value !== globalEmailBg) el.value = globalEmailBg; });
}

function addSeg(storeId, type) {
  const listId = type === 'vip' ? `vip-segs-${storeId}` : `segs-${storeId}`;
  const container = document.getElementById(listId);
  if (!container) return;
  const row = document.createElement('div');
  row.className = 'seg-row';
  const ph = type === 'vip' ? 'VIP List or Segment ID' : 'List or Segment ID';
  row.innerHTML = `<input type="text" placeholder="${ph}"><button class="seg-del" onclick="delSeg('${storeId}','${type}',this)">Ã—</button>`;
  container.appendChild(row);
  row.querySelector('input').focus();
}

function delSeg(storeId, type, btn) {
  const container = btn.closest('.seg-list');
  const rows = container.querySelectorAll('.seg-row');
  if (rows.length <= 1) { btn.closest('.seg-row').querySelector('input').value = ''; return; }
  btn.closest('.seg-row').remove();
}

function getSegs(storeId, type) {
  const listId = type === 'vip' ? `vip-segs-${storeId}` : `segs-${storeId}`;
  const container = document.getElementById(listId);
  if (!container) return storeCfgs[storeId][type === 'vip' ? 'vipLists' : 'lists'] || [];
  return Array.from(container.querySelectorAll('input')).map(i => i.value.trim()).filter(Boolean);
}

function setGlobalLh(val) {
  const lh = parseFloat(val);
  if (isNaN(lh) || lh < 0.5) return;
  globalLineHeight = lh;
  localStorage.setItem('ehub5_lh', String(lh));
  document.querySelectorAll('#globalLhInput').forEach(el => { if (parseFloat(el.value) !== lh) el.value = lh; });
}

function setCtaStyle(prop, val) {
  if (prop === 'radius')  { ctaBorderRadius = val; localStorage.setItem('ehub5_cta_radius', val); }
  if (prop === 'fsize')   { ctaFontSize = val;     localStorage.setItem('ehub5_cta_fsize', val); }
  if (prop === 'pad')     { ctaPadding = val;       localStorage.setItem('ehub5_cta_pad', val); }
  if (prop === 'weight')  { ctaFontWeight = val;   localStorage.setItem('ehub5_cta_weight', val); }
  if (prop === 'color')   { ctaTextColor = val;    localStorage.setItem('ehub5_cta_color', val); }
  updateCtaPreview();
}

function updateCtaPreview() {
  const el = document.getElementById('ctaPreview');
  if (!el) return;
  el.style.borderRadius  = ctaBorderRadius;
  el.style.fontSize      = `${ctaFontSize}px`;
  el.style.padding       = ctaPadding;
  el.style.fontWeight    = ctaFontWeight;
  el.style.color         = ctaTextColor;
  el.style.fontFamily    = `${globalFont},sans-serif`;
}

function updateSubjCount(region, val) {
  const len = val.length;
  const el = document.getElementById(`${region}-subj-count`);
  if (!el) return;
  el.textContent = len;
  el.className = 'subj-count' + (len > 70 ? ' over' : len > 60 ? ' warn' : '');
}

function copyFromUS() {
  // Copy subject + preheader fields
  ['subject','preheader'].forEach(f => {
    const src = document.getElementById(`us-${f}`);
    const dst = document.getElementById(`uk-${f}`);
    if (src && dst) dst.value = src.value;
  });
  // Deep-copy block stack, swapping .com â†’ .uk in all link fields
  saveBlockInputs('us');
  blockStacks['uk'] = blockStacks['us'].map(block => {
    const b = JSON.parse(JSON.stringify(block));
    b.id = newBlockId(); // new IDs to avoid collisions
    if (b.type === 'cta')   b.data.href = (b.data.href  || '').replace(/\.com\b/g, '.uk');
    if (b.type === 'image') b.data.link = (b.data.link  || '').replace(/\.com\b/g, '.uk');
    if (b.type === 'text')  b.data.html = (b.data.html  || '').replace(/href="([^"]*)\.com\b/g, 'href="$1.uk');
    return b;
  });
  renderBlockStack('uk');
  // Copy discount
  const srcDisc = document.getElementById('us-discount');
  const dstDisc = document.getElementById('uk-discount');
  if (srcDisc && dstDisc) dstDisc.value = srcDisc.value;
  const ukSubj = document.getElementById('uk-subject');
  if (ukSubj) updateSubjCount('uk', ukSubj.value);
  scheduleCheck();
  showToast('â†™ Copied US â†’ UK â€” check spellings & links!', 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function saveStore(id) {
  const g = key => { const el = document.getElementById(`sc-${id}-${key}`); return el ? el.value.trim() : ''; };
  const tc = document.getElementById(`sc-${id}-textColor-t`);
  const bg = document.getElementById(`sc-${id}-bodyBg-t`);
  storeCfgs[id] = {
    senderName: g('senderName'), senderEmail: g('senderEmail'), replyTo: g('replyTo'),
    header: storeCfgs[id].header, footer: storeCfgs[id].footer,
    textColor: (tc && /^#[0-9a-fA-F]{6}$/.test(tc.value)) ? tc.value : (storeCfgs[id].textColor || '#444444'),
    bodyBg:    (bg && /^#[0-9a-fA-F]{6}$/.test(bg.value)) ? bg.value : (storeCfgs[id].bodyBg    || '#ffffff'),
    fontFamily: globalFont,
  };
  localStorage.setItem(`ehub5_${id}`, JSON.stringify(storeCfgs[id]));
  updateReady();
  showToast(`âœ… ${id.toUpperCase()} saved!`, 'ok');
}

function saveAllStores() {
  STORES.forEach(s => saveStore(s.id));
  showToast('âœ… All stores saved!', 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOGGLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleDiscount() {
  discountOn = !discountOn;
  document.getElementById('discTog').classList.toggle('on', discountOn);
  document.querySelectorAll('[id^="disc-block-"]').forEach(el => el.style.display = discountOn ? 'block' : 'none');
}

function toggleVip() {
  vipOn = !vipOn;
  const tog = document.getElementById('vipTog');
  tog.classList.toggle('on', false);
  tog.classList.toggle('vip-on', vipOn);
  document.querySelectorAll('[id^="vip-"]').forEach(el => el.classList.toggle('show', vipOn));
  document.getElementById('vipBadge').classList.toggle('show', vipOn);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// RTE now operates on block IDs â€” editor element is `${bid}-editor`
function rteCmd(bid, cmd) { const ed = document.getElementById(`${bid}-editor`); if (!ed) return; ed.focus(); document.execCommand(cmd, false, null); updateChip(bid); }

function openLP(bid) {
  const sel = window.getSelection();
  if (!sel || !sel.rangeCount || !sel.toString().trim()) { showToast('âš ï¸ Select text first', 'err'); return; }
  savedRange = sel.getRangeAt(0).cloneRange();
  activeLinkRegion = bid;
  document.getElementById('lpSel').textContent = `"${sel.toString().trim()}"`;
  const a = getAnchor();
  document.getElementById('lpUrl').value = a ? a.href : 'https://';
  const tb = document.getElementById(`tb-${bid}`);
  const rect = tb.getBoundingClientRect();
  const popup = document.getElementById('linkPopup');
  popup.classList.add('open');
  let top = rect.bottom + 5, left = rect.left;
  if (left + 300 > window.innerWidth) left = window.innerWidth - 316;
  if (top + 180 > window.innerHeight) top = rect.top - 188;
  popup.style.top = `${top}px`; popup.style.left = `${left}px`;
  setTimeout(() => document.getElementById('lpUrl').focus(), 40);
}

function closeLinkPopup() { document.getElementById('linkPopup').classList.remove('open'); savedRange = null; activeLinkRegion = null; }

function applyLink() {
  const url = document.getElementById('lpUrl').value.trim();
  if (!url || url === 'https://') { showToast('âš ï¸ Enter a URL', 'err'); return; }
  const bid = activeLinkRegion;
  const ed = document.getElementById(`${bid}-editor`);
  if (!ed) return;
  ed.focus();
  if (savedRange) { const s = window.getSelection(); s.removeAllRanges(); s.addRange(savedRange); }
  document.execCommand('createLink', false, url);
  ed.querySelectorAll('a').forEach(a => { a.target = '_blank'; a.rel = 'noopener'; });
  closeLinkPopup(); updateChip(bid); scheduleCheck();
  showToast('âœ… Link added!', 'ok');
}

function removeLink(bid) {
  const ed = document.getElementById(`${bid}-editor`); if (!ed) return; ed.focus();
  const a = getAnchor();
  if (a) { const rng = document.createRange(); rng.selectNodeContents(a); const s = window.getSelection(); s.removeAllRanges(); s.addRange(rng); }
  document.execCommand('unlink', false, null); updateChip(bid);
}

function getAnchor() {
  const sel = window.getSelection(); if (!sel || !sel.rangeCount) return null;
  let n = sel.getRangeAt(0).commonAncestorContainer;
  while (n && n.nodeName !== 'A') n = n.parentNode;
  return n && n.nodeName === 'A' ? n : null;
}

function updateChip(bid) {
  const a = getAnchor();
  const chip = document.getElementById(`chip-${bid}`);
  const txt  = document.getElementById(`chip-txt-${bid}`);
  if (!chip) return;
  if (a) { chip.classList.add('show'); txt.textContent = a.href.length > 26 ? a.href.slice(0,26)+'â€¦' : a.href; }
  else chip.classList.remove('show');
}

document.addEventListener('selectionchange', () => {
  const active = document.activeElement;
  if (active && active.classList.contains('rte-editor') && active.id) updateChip(active.id.replace('-editor',''));
});
document.addEventListener('mousedown', e => { const p = document.getElementById('linkPopup'); if (p.classList.contains('open') && !p.contains(e.target)) closeLinkPopup(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINK CHECKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function scheduleCheck() { clearTimeout(checkTimer); checkTimer = setTimeout(runLinkCheck, 800); }

function getAllLinks() {
  const links = [];
  STORES.forEach(s => {
    const r = s.region;
    // CTA blocks
    blockStacks[r].forEach(block => {
      if (block.type === 'cta' && block.data.href) links.push({ store:s, url:block.data.href, fieldId:`${block.id}-href`, field:'cta block', inline:false });
      if (block.type === 'image' && block.data.link) links.push({ store:s, url:block.data.link, fieldId:`${block.id}-link`, field:'img link', inline:false });
      if (block.type === 'text') {
        const ed = document.getElementById(`${block.id}-editor`);
        if (ed) ed.querySelectorAll('a').forEach((a,i) => { if (a.href) links.push({ store:s, url:a.href, fieldId:`${block.id}-editor`, field:'inline', inline:true, idx:i }); });
      }
    });
    if (vipOn) {
      const vipLink = document.getElementById(`${r}-vip-ctalink`);
      if (vipLink && vipLink.value.trim()) links.push({ store:s, url:vipLink.value.trim(), fieldId:`${r}-vip-ctalink`, field:'â­ vip cta', inline:false });
    }
  });
  return links;
}

function checkLink(store, url) {
  try { const host = new URL(url).hostname; return host.endsWith(store.domain.replace(/^\./,'')) ? 'ok' : 'warn'; }
  catch { return 'neutral'; }
}

// Repair a link by swapping its domain to the correct one for the store
function repairLink(storeId, fieldId, url, isInline, inlineIdx) {
  const store = STORES.find(s => s.id === storeId);
  if (!store) return;
  let fixed;
  try {
    const u = new URL(url);
    // extract current TLD â€” everything after last dot-segment before path
    // Replace entire hostname's TLD with store's correct domain
    const targetTld = store.domain; // e.g. '.uk', '.cz', '.de'
    // Match known domains and swap
    const knownTlds = ['.com', '.co.uk', '.uk', '.cz', '.de', '.eu', '.sg'];
    let replaced = false;
    for (const tld of knownTlds) {
      if (u.hostname.endsWith(tld.replace(/^\./,''))) {
        u.hostname = u.hostname.slice(0, u.hostname.length - tld.replace(/^\./,'').length) + targetTld.replace(/^\./,'');
        replaced = true; break;
      }
    }
    if (!replaced) return showToast('âš ï¸ Could not determine domain to replace', 'err');
    fixed = u.toString();
  } catch { return showToast('âš ï¸ Invalid URL', 'err'); }

  if (isInline) {
    const body = document.getElementById(fieldId);
    if (body) { const anchors = body.querySelectorAll('a'); if (anchors[inlineIdx]) anchors[inlineIdx].href = fixed; }
  } else {
    const el = document.getElementById(fieldId);
    if (el) el.value = fixed;
  }
  scheduleCheck();
  showToast(`âœ… Repaired â†’ ${fixed}`, 'ok');
}

function runLinkCheck() {
  const links = getAllLinks();
  const c = document.getElementById('linkResults');
  const s = document.getElementById('linkSummary');
  if (!links.length) { c.innerHTML = `<div style="padding:18px;color:var(--muted);font-size:12px;text-align:center;">No links found yet.</div>`; s.textContent = 'No links'; return; }
  let ok = 0, warn = 0;
  c.innerHTML = `<div class="chk-area">${links.map(({store, url, fieldId, field, inline, idx}) => {
    const st = checkLink(store, url);
    if (st === 'ok') ok++; else if (st === 'warn') warn++;
    const repairBtn = st === 'warn'
      ? `<button class="chk-repair" onclick="repairLink('${store.id}','${fieldId}','${url.replace(/'/g,"\\'")}',${inline||false},${idx||0})">âš¡ Fix â†’ ${store.domain}</button>`
      : '';
    return `<div class="chk-row">
      <div class="ci ci-${st}">${st==='ok'?'âœ“':st==='warn'?'âœ•':'?'}</div>
      <span style="font-size:10px;color:var(--muted);width:22px;flex-shrink:0;">${store.flag}</span>
      <span class="chk-url ${st==='warn'?'bad':''}" title="${url}">${url}</span>
      <span class="chk-tag">${field}</span>
      <span class="chk-tag ${st==='warn'?'warn':''}">exp:${store.domain}</span>
      ${repairBtn}
    </div>`;
  }).join('')}</div>`;
  s.textContent = `${links.length} links â€” ${ok} OK${warn>0?` Â· âš ï¸ ${warn} domain mismatch`:''}`;
  s.style.color = warn>0 ? 'var(--red)' : 'var(--green)';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAIL BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function gv(id) { const el = document.getElementById(id); if (!el) return ''; if (el.contentEditable==='true') return el.innerHTML.trim(); return el.value ? el.value.trim() : ''; }

function buildEmail(store, isVip = false) {
  const r    = store.region;
  const cfg  = storeCfgs[store.id];
  const font = globalFont;
  const tc   = cfg.textColor || '#444444';
  const vipCtaOverride = isVip ? gv(`${r}-vip-ctalink`) : '';

  const subject   = isVip ? (gv(`${r}-vip-subject`)  || gv(`${r}-subject`))   : gv(`${r}-subject`);
  const preheader = isVip ? (gv(`${r}-vip-preheader`) || gv(`${r}-preheader`)) : gv(`${r}-preheader`);
  const discount  = discountOn ? gv(`${r}-discount`) : '';

  // Snapshot block inputs, then render each block to email HTML
  saveBlockInputs(r);
  const blocks = blockStacks[r];
  const bgStyle = (cfg.bodyBg && cfg.bodyBg !== '#ffffff') ? `background:${cfg.bodyBg};` : '';

  const blockRows = blocks.map(block => {
    if (block.type === 'text') {
      const html = rteToEmail(block.data.html, tc, font);
      return html ? `<tr><td style="padding:18px 40px 4px;${bgStyle}">${html}</td></tr>` : '';
    }
    if (block.type === 'image') {
      const src   = block.data.src   || '';
      const alt   = block.data.alt   || '';
      const width = block.data.width || '100%';
      const pad   = block.data.pad   || '12px 0';
      const link  = block.data.link  || '';
      if (!src) return '';
      const img = `<img src="${esc(src)}" alt="${esc(alt)}" width="${esc(width)}" style="display:block;max-width:100%;height:auto;border:0;" border="0">`;
      const inner = link ? `<a href="${esc(link)}" target="_blank" style="display:block;">${img}</a>` : img;
      return `<tr><td align="center" style="padding:${pad};${bgStyle}">${inner}</td></tr>`;
    }
    if (block.type === 'cta') {
      const label = block.data.text || '';
      const href  = (isVip && vipCtaOverride) ? vipCtaOverride : (block.data.href || '#');
      if (!label) return '';
      return `<tr><td align="center" style="padding:10px 40px 20px;${bgStyle}"><a href="${esc(href)}" target="_blank" style="display:inline-block;background:#3d6eff;color:${ctaTextColor};text-decoration:none;padding:${ctaPadding};border-radius:${ctaBorderRadius};font-family:${font},sans-serif;font-size:${ctaFontSize}px;font-weight:${ctaFontWeight};">${esc(label)}</a></td></tr>`;
    }
    if (block.type === 'spacer') {
      const h = parseInt(block.data.height) || 24;
      return `<tr><td style="height:${h}px;font-size:0;line-height:0;">&nbsp;</td></tr>`;
    }
    return '';
  }).filter(Boolean).join('\n');

  const discountRow = discount ? `<tr><td style="padding:0 40px 18px;${bgStyle}"><div style="border:2px dashed #3d6eff;border-radius:9px;padding:16px;text-align:center;"><p style="margin:0 0 4px;font-family:${font},sans-serif;color:#888;font-size:11px;text-transform:uppercase;letter-spacing:1px;">Discount code</p><p style="margin:0;font-family:${font},sans-serif;color:#3d6eff;font-size:22px;font-weight:800;letter-spacing:3px;">${discount}</p></div></td></tr>` : '';

  const innerTable = `<table role="presentation" width="100%" cellpadding="0" cellspacing="0">
${blockRows}
${discountRow}
</table>`;

  const wrapOpen  = `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="background:${globalPageBg};"><tr><td align="center" style="padding:24px 16px;"><table role="presentation" width="600" cellpadding="0" cellspacing="0" style="max-width:600px;width:100%;background:${globalEmailBg};">`;
  const wrapClose = `</table></td></tr></table>`;

  return { subject, preheader, html: wrapOpen + innerTable + wrapClose };
}

function defHeader() { return ''; }
function defFooter() { return ''; }

function rteToEmail(html, tc, font) {
  if (!html) return '';
  const tmp = document.createElement('div'); tmp.innerHTML = html;
  const ps = `margin:0 0 14px;font-family:${font},sans-serif;color:${tc};font-size:16px;line-height:${globalLineHeight};`;
  function inline(node) {
    let r = '';
    node.childNodes.forEach(c => {
      if (c.nodeType===3) r += c.textContent;
      else if (c.nodeName==='A') r += `<a href="${c.href}" style="color:#3d6eff;text-decoration:underline;font-family:${font},sans-serif;" target="_blank">${c.textContent}</a>`;
      else if (c.nodeName==='B'||c.nodeName==='STRONG') r += `<strong style="font-weight:700;">${inline(c)}</strong>`;
      else if (c.nodeName==='I'||c.nodeName==='EM') r += `<em>${inline(c)}</em>`;
      else if (c.nodeName==='U') r += `<span style="text-decoration:underline;">${inline(c)}</span>`;
      else if (c.nodeName==='BR') r += '<br>';
      else r += inline(c);
    });
    return r;
  }
  let out = '';
  tmp.childNodes.forEach(n => {
    if (n.nodeType===3) { if (n.textContent.trim()) out += `<p style="${ps}">${n.textContent}</p>`; }
    else if (['DIV','P'].includes(n.nodeName)) { const i = inline(n); if (i.trim()) out += `<p style="${ps}">${i}</p>`; }
    else if (n.nodeName!=='BR') { const i = inline(n); if (i.trim()) out += `<p style="${ps}">${i}</p>`; }
  });
  if (!out && html.trim()) { const t = document.createElement('span'); t.innerHTML = html; out = `<p style="${ps}">${inline(t)}</p>`; }
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OUTPUT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openOutput() {
  const name = document.getElementById('campaignName').value.trim() || 'Campaign';
  generated = {};
  const items = [];
  STORES.forEach(s => {
    const reg = s.region;
    const built = buildEmail(s, false);
    generated[s.id] = { store:s, subject:built.subject || `${name} â€” ${s.label}`, preheader:built.preheader, html:built.html, isVip:false };
    items.push({ key:s.id, store:s, isVip:false });
    if (vipOn) {
      const vipBuilt = buildEmail(s, true);
      const vipListOverride = gv(`${s.region}-vip-listid`);
      const vipListIds = vipListOverride ? [vipListOverride] : (storeCfgs[s.id].vipLists || []);
      generated[`vip_${s.id}`] = { store:s, subject:vipBuilt.subject || `VIP_ ${name} â€” ${s.label}`, preheader:vipBuilt.preheader, html:vipBuilt.html, isVip:true, vipListIds };
      items.push({ key:`vip_${s.id}`, store:s, isVip:true });
    }
  });

  document.getElementById('outTabs').innerHTML = items.map((it,i) =>
    `<button class="out-tab ${i===0?'active':''} ${it.isVip?'vip-tab':''}" id="otab-${it.key}" onclick="switchOut('${it.key}')">
      ${it.store.flag} ${it.store.label}${it.isVip?' â­':''}
    </button>`).join('');

  document.getElementById('outBody').innerHTML = items.map((it,i) => {
    const em = generated[it.key];
    const cfg = storeCfgs[it.store.id];
    const hasKey = !!cfg.apiKey;
    return `<div class="out-sec ${i===0?'active':''}" id="osec-${it.key}">
      ${it.isVip?`<div style="background:var(--vip-dim);border:1px solid rgba(192,132,252,0.2);border-radius:8px;padding:8px 12px;margin-bottom:12px;font-size:11px;color:var(--vip);">â­ VIP Campaign â€” different links, subject & list ID</div>`:''}
      <div class="meta-grid">
        <div class="mp"><div class="mp-l">Subject</div><div class="mp-v">${em.subject||'â€”'}</div></div>
        <div class="mp"><div class="mp-l">Preheader</div><div class="mp-v">${em.preheader||'â€”'}</div></div>
        <div class="mp"><div class="mp-l">From</div><div class="mp-v">${cfg.senderName||'â€”'}</div></div>
        <div class="mp"><div class="mp-l">Sender email</div><div class="mp-v">${cfg.senderEmail||'â€”'}</div></div>
        <div class="mp"><div class="mp-l">List IDs</div><div class="mp-v">${it.isVip ? (em.vipListIds||[]).join(', ')||'â€”' : (cfg.lists||[]).join(', ')||'â€”'}</div></div>
        <div class="mp"><div class="mp-l">API Key</div><div class="mp-v">${hasKey?'âœ… Set':'âš ï¸ Missing'}</div></div>
      </div>
      <div style="display:flex;gap:7px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
        <button class="btn btn-ghost btn-sm" onclick="copyHtml('${it.key}')">ğŸ“‹ Copy HTML</button>
        <button class="btn btn-ghost btn-sm" onclick="dlHtml('${it.key}')">â¬‡ï¸ Download</button>
        <button class="btn btn-ghost btn-sm" onclick="toggleCode('${it.key}')">ğŸ‘¨â€ğŸ’» Code</button>
        <button class="btn ${it.isVip?'btn-vip':'btn-green'} btn-sm" id="pbtn-${it.key}" onclick="pushKlaviyo('${it.key}')">
          ${hasKey?(it.isVip?'â­ Push VIP':'ğŸš€ Push to Klaviyo'):'ğŸ”‘ Add API key first'}
        </button>
        <span id="pst-${it.key}" style="font-size:11px;color:var(--muted);"></span>
      </div>
      <iframe id="prev-${it.key}" srcdoc="" style="width:100%;border:none;border-radius:9px;min-height:480px;background:white;"></iframe>
      <div id="code-${it.key}" style="display:none;"><div class="code-block">${escH(em.html)}</div></div>
    </div>`;
  }).join('');

  document.getElementById('outputModal').classList.add('open');
  requestAnimationFrame(() => { items.forEach(it => { const fr = document.getElementById(`prev-${it.key}`); if (fr) fr.srcdoc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{margin:0;padding:20px;background:#f4f4f6;font-family:${globalFont},sans-serif;}</style></head><body>${generated[it.key].html}</body></html>`; }); });
}

function switchOut(id) {
  document.querySelectorAll('.out-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.out-sec').forEach(s => s.classList.remove('active'));
  document.getElementById(`otab-${id}`).classList.add('active');
  document.getElementById(`osec-${id}`).classList.add('active');
}
function closeOutput() { document.getElementById('outputModal').classList.remove('open'); }
document.getElementById('outputModal').addEventListener('click', e => { if (e.target.id==='outputModal') closeOutput(); });

function copyHtml(id) { navigator.clipboard.writeText(generated[id].html); showToast('ğŸ“‹ Copied!','ok'); }
function dlHtml(id) {
  const { store, html, isVip } = generated[id];
  const name = document.getElementById('campaignName').value.trim() || 'campaign';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([html],{type:'text/html'}));
  a.download = `${name.replace(/\s+/g,'_')}_${store.label}${isVip?'_VIP':''}.html`;
  a.click();
}
function toggleCode(id) { const el = document.getElementById(`code-${id}`); el.style.display = el.style.display==='none'?'block':'none'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KLAVIYO API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function pushKlaviyo(key) {
  const em = generated[key];
  const cfg = storeCfgs[em.store.id];
  const name = document.getElementById('campaignName').value.trim() || 'Email Hub';
  const stel = document.getElementById(`pst-${key}`);
  const btn  = document.getElementById(`pbtn-${key}`);

  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span> Creatingâ€¦';

  const campaignName = em.isVip ? `VIP_ ${name} â€” ${em.store.label}` : `${name} â€” ${em.store.label}`;

  try {
    const res = await fetch('/.netlify/functions/push-campaign', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        storeId:      em.store.id,
        campaignName,
        subject:      em.subject,
        preheader:    em.preheader || '',
        senderName:   cfg.senderName,
        senderEmail:  cfg.senderEmail,
        replyTo:      cfg.replyTo || cfg.senderEmail,
        listIds:      em.isVip ? (em.vipListIds || []) : (cfg.lists || []),
        isVip:        em.isVip || false,
      }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error || `Server error ${res.status}`);
    stel.textContent = `âœ… Created â€” ${data.campaignId}`; stel.style.color = 'var(--green)';
    btn.innerHTML = 'âœ… Done';
    showToast(`âœ… ${campaignName} created!`, 'ok');
  } catch(err) {
    stel.textContent = `âŒ ${err.message}`; stel.style.color = 'var(--red)';
    btn.disabled = false; btn.innerHTML = 'ğŸš€ Retry';
    showToast(`âŒ ${err.message}`, 'err');
  }
}

async function pushAll() {
  const keys = Object.keys(generated);
  const btn = document.getElementById('pushAllBtn');
  const status = document.getElementById('pushAllStatus');
  btn.disabled = true;
  let done = 0, failed = 0;
  for (const key of keys) {
    const cfg = storeCfgs[generated[key].store.id];
    if (!cfg.apiKey) { failed++; continue; }
    status.textContent = `Pushing ${done + failed + 1} / ${keys.length}â€¦`;
    try {
      await pushKlaviyo(key);
      done++;
    } catch {
      failed++;
    }
    await new Promise(r => setTimeout(r, 400)); // brief pause between API calls
  }
  btn.disabled = false;
  status.textContent = `${done} pushed${failed ? ` Â· ${failed} skipped (no API key)` : ''}`;
  status.style.color = failed ? 'var(--amber)' : 'var(--green)';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// READY COUNT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateReady() {
  let n = 0;
  STORES.forEach(s => {
    const r = s.region;
    const sub = document.getElementById(`${r}-subject`);
    const hasContent = blockStacks[r] && blockStacks[r].some(b => b.type === 'text' && (b.data.html||'').trim());
    if ((sub && sub.value.trim()) && hasContent && storeCfgs[s.id].senderEmail) n++;
  });
  document.getElementById('readyBadge').textContent = `${n} / 6 ready`;
}setInterval(updateReady, 2500);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PW_KEY = 'ehub5_pw';
const DEFAULT_PW = 'emailhub2025';

async function hashPw(pw) { const b = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw)); return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join(''); }

async function initLock() {
  if (!localStorage.getItem(PW_KEY)) {
    localStorage.setItem(PW_KEY, await hashPw(DEFAULT_PW));
    document.getElementById('lNote').innerHTML = `Default: <strong style="color:var(--text);letter-spacing:1px;">${DEFAULT_PW}</strong><br>Change via ğŸ”‘ after login.`;
  }
  setTimeout(() => document.getElementById('lInp').focus(), 100);
}

async function tryUnlock() {
  const v = document.getElementById('lInp').value; if (!v) return;
  if (await hashPw(v) === localStorage.getItem(PW_KEY)) {
    document.getElementById('lockScreen').classList.add('gone');
    document.getElementById('appShell').style.display = 'block';
    document.getElementById('lInp').value = '';
    bootApp();
  } else {
    const i = document.getElementById('lInp');
    i.classList.add('shake'); document.getElementById('lErr').textContent = 'Incorrect password.';
    setTimeout(() => i.classList.remove('shake'), 420); i.select();
  }
}

function lockApp() { document.getElementById('appShell').style.display='none'; document.getElementById('lockScreen').classList.remove('gone'); document.getElementById('lInp').value=''; document.getElementById('lErr').textContent=''; setTimeout(()=>document.getElementById('lInp').focus(),100); }
function toggleEye() { const i = document.getElementById('lInp'); i.type = i.type==='password'?'text':'password'; }
function togglePwBar() { document.getElementById('pwBar').classList.toggle('open'); if (document.getElementById('pwBar').classList.contains('open')) setTimeout(()=>document.getElementById('newPw').focus(),40); }
async function savePw() { const pw = document.getElementById('newPw').value.trim(); if (pw.length<6){showToast('âš ï¸ Min 6 chars','err');return;} localStorage.setItem(PW_KEY, await hashPw(pw)); document.getElementById('newPw').value=''; document.getElementById('pwBar').classList.remove('open'); showToast('âœ… Password updated!','ok'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escH(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function showToast(msg, type='ok') { const t=document.getElementById('toast'); t.textContent=msg; t.className=`toast t-${type} show`; setTimeout(()=>t.classList.remove('show'),3500); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function bootApp() {
  REGIONS.forEach(r => {
    document.getElementById(`cform-${r.id}`).innerHTML = buildContentForm(r.id);
    if (blockStacks[r.id].length === 0) addBlock(r.id, 'text');
    else renderBlockStack(r.id);
  });
  renderStorePanels();
  renderLayoutChips();
  runLinkCheck();
}

initLock();
</script>
</body>
</html>
